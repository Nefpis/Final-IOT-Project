<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Firestore Diagnostic</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #0f0;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }
        h1 {
            color: #0ff;
            text-align: center;
        }
        .test {
            background: #000;
            border: 2px solid #0f0;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .test h3 {
            margin: 0 0 10px 0;
            color: #ff0;
        }
        .status {
            padding: 5px 10px;
            border-radius: 3px;
            display: inline-block;
            margin: 5px 0;
        }
        .success { background: #0f0; color: #000; }
        .error { background: #f00; color: #fff; }
        .info { background: #00f; color: #fff; }
        pre {
            background: #222;
            padding: 10px;
            overflow-x: auto;
            border-left: 3px solid #0ff;
        }
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
        }
        button:hover {
            background: #0ff;
        }
        .log {
            background: #111;
            border-left: 3px solid #ff0;
            padding: 10px;
            margin: 5px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üîç FIRESTORE DIAGNOSTIC TOOL</h1>
    
    <div class="test">
        <h3>üìä Status Dashboard</h3>
        <div id="dashboard">Initializing...</div>
    </div>

    <div class="test">
        <h3>üîß Actions</h3>
        <button onclick="testConnection()">Test Firestore Connection</button>
        <button onclick="testUserCreation()">Test User Profile Creation</button>
        <button onclick="checkRules()">Check Security Rules</button>
        <button onclick="viewUsers()">View Users Collection</button>
    </div>

    <div class="test">
        <h3>üìù Console Log</h3>
        <div id="log"></div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Your Firebase Config -->
    <script src="../js/firebase-config.js"></script>

    <script>
        const logDiv = document.getElementById('log');
        const dashDiv = document.getElementById('dashboard');

        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : '#0ff';
            logDiv.innerHTML += `<div class="log" style="border-left-color: ${color}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function updateDashboard() {
            const user = Firebase.auth.currentUser;
            dashDiv.innerHTML = `
                <div class="status ${user ? 'success' : 'error'}">
                    Auth: ${user ? '‚úÖ Logged In' : '‚ùå Not Logged In'}
                </div>
                ${user ? `
                    <div class="status info">User ID: ${user.uid}</div>
                    <div class="status info">Email: ${user.email}</div>
                ` : ''}
            `;
        }

        async function testConnection() {
            log('üîÑ Testing Firestore connection...', 'info');
            
            try {
                // Try to read from Firestore
                const snapshot = await Firebase.db.collection('_test').limit(1).get();
                log('‚úÖ Firestore connection successful!', 'success');
                return true;
            } catch (error) {
                log('‚ùå Firestore connection failed: ' + error.message, 'error');
                log('Error code: ' + error.code, 'error');
                return false;
            }
        }

        async function testUserCreation() {
            log('üîÑ Testing user profile creation...', 'info');
            
            const user = Firebase.auth.currentUser;
            if (!user) {
                log('‚ùå No user logged in! Please register first.', 'error');
                return;
            }

            log('Current user ID: ' + user.uid, 'info');

            try {
                // Try to create a test profile
                const testData = {
                    email: user.email,
                    name: 'Test User',
                    firstname: 'Test',
                    lastname: 'User',
                    photo: '../img/user.jpg',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    _test: true
                };

                log('Attempting to write to: users/' + user.uid, 'info');
                
                await Firebase.db.collection('users').doc(user.uid).set(testData);
                
                log('‚úÖ Write successful!', 'success');
                
                // Try to read it back
                const doc = await Firebase.db.collection('users').doc(user.uid).get();
                
                if (doc.exists) {
                    log('‚úÖ Read successful! Document exists.', 'success');
                    log('Document data: ' + JSON.stringify(doc.data(), null, 2), 'info');
                } else {
                    log('‚ùå Document was written but cannot be read!', 'error');
                }

            } catch (error) {
                log('‚ùå User profile creation failed!', 'error');
                log('Error: ' + error.message, 'error');
                log('Error code: ' + error.code, 'error');
                
                if (error.code === 'permission-denied') {
                    log('‚ö†Ô∏è PERMISSION DENIED! This means:', 'error');
                    log('1. Your Firestore security rules are blocking this', 'error');
                    log('2. You need to update your security rules', 'error');
                    log('3. Check Firebase Console ‚Üí Firestore ‚Üí Rules', 'error');
                }
            }
        }

        async function checkRules() {
            log('üîÑ Checking Firestore rules...', 'info');
            
            try {
                // Test read permission
                log('Testing READ permission...', 'info');
                await Firebase.db.collection('users').limit(1).get();
                log('‚úÖ READ permission OK', 'success');
            } catch (e) {
                log('‚ùå READ permission DENIED: ' + e.message, 'error');
            }

            try {
                // Test write permission
                log('Testing WRITE permission...', 'info');
                const user = Firebase.auth.currentUser;
                if (user) {
                    await Firebase.db.collection('users').doc(user.uid).set({ test: true }, { merge: true });
                    log('‚úÖ WRITE permission OK', 'success');
                } else {
                    log('‚ö†Ô∏è Cannot test WRITE - not logged in', 'error');
                }
            } catch (e) {
                log('‚ùå WRITE permission DENIED: ' + e.message, 'error');
                if (e.code === 'permission-denied') {
                    log('üîß SOLUTION: Go to Firebase Console ‚Üí Firestore ‚Üí Rules', 'info');
                    log('Change to: allow read, write: if request.auth != null;', 'info');
                }
            }
        }

        async function viewUsers() {
            log('üîÑ Fetching users collection...', 'info');
            
            try {
                const snapshot = await Firebase.db.collection('users').get();
                
                if (snapshot.empty) {
                    log('‚ö†Ô∏è Users collection is EMPTY!', 'error');
                    log('This means profiles are NOT being created', 'error');
                } else {
                    log(`‚úÖ Found ${snapshot.size} user(s) in database`, 'success');
                    snapshot.forEach(doc => {
                        log(`User: ${doc.id}`, 'info');
                        log(JSON.stringify(doc.data(), null, 2), 'info');
                    });
                }
            } catch (error) {
                log('‚ùå Cannot read users collection: ' + error.message, 'error');
                log('Error code: ' + error.code, 'error');
            }
        }

        // Auto-check on load
        Firebase.auth.onAuthStateChanged(async (user) => {
            updateDashboard();
            
            if (user) {
                log('‚úÖ User authenticated: ' + user.email, 'success');
                log('User ID: ' + user.uid, 'info');
                
                // Auto-test
                await testConnection();
                await checkRules();
                await viewUsers();
            } else {
                log('‚ö†Ô∏è No user logged in', 'error');
                log('Please register or login first, then refresh this page', 'info');
            }
        });
    </script>
</body>
</html>